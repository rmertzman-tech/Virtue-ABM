<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtue Ethics: Individual & Community - Ethics Beyond Boundaries</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .header-buttons {
            position: absolute;
            top: 30px;
            right: 30px;
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: white;
            color: #667eea;
            transform: scale(1.1);
        }

        /* Mode Toggle */
        .mode-selector {
            background: #f8f9fa;
            padding: 30px;
            text-align: center;
            border-bottom: 3px solid #dee2e6;
        }

        .mode-toggle {
            display: inline-flex;
            background: white;
            border-radius: 15px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .mode-btn {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s;
            color: #666;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .mode-description {
            max-width: 800px;
            margin: 20px auto 0;
            color: #666;
            line-height: 1.8;
        }

        /* Network Visualization */
        .network-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 30px 0;
            overflow: hidden;
        }

        #networkCanvas {
            width: 100%;
            height: 100%;
        }

        .network-legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin: 30px 0;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Community Stats */
        .community-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
        }

        .stat-change {
            font-size: 16px;
            margin-top: 8px;
            opacity: 0.9;
        }

        /* Institutional Context */
        .institution-selector {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }

        .institution-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .institution-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .institution-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .institution-card.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .institution-card.extractive {
            border-color: #f44336;
            background: #ffebee;
        }

        .institution-card h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        /* Repair Loop Tracking */
        .repair-loop-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }

        .repair-loop-row {
            display: grid;
            grid-template-columns: 150px 1fr 100px;
            gap: 20px;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .loop-label {
            font-weight: 600;
            color: #667eea;
        }

        .loop-bar {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
        }

        .loop-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.5s ease;
        }

        .loop-count {
            font-weight: bold;
            font-size: 20px;
            color: #667eea;
            text-align: center;
        }

        /* Everything else from original */
        .content {
            padding: 40px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .explanation-box {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .explanation-box h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .scenario-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 30px 0;
        }

        .scenario-text {
            font-size: 1.1em;
            line-height: 1.8;
            color: #333;
            margin: 20px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .choice-button {
            display: block;
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1.05em;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .choice-button:hover {
            border-color: #667eea;
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .choice-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            display: block;
        }

        button {
            padding: 15px 35px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .button-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        h2 {
            color: #667eea;
            font-size: 2.2em;
            margin-bottom: 20px;
            text-align: center;
        }

        h3 {
            color: #667eea;
            font-size: 1.6em;
            margin: 30px 0 20px 0;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .mode-toggle {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-buttons">
                <button class="icon-btn" onclick="showInfo()" title="About">‚ÑπÔ∏è</button>
            </div>
            <h1>üèõÔ∏è Virtue Ethics: Individual & Community</h1>
            <p>Exploring Character Development Through Multi-Scale Dynamics</p>
        </div>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <h2 style="margin-bottom: 20px;">Choose Your Exploration Mode</h2>
            
            <div class="mode-toggle">
                <button class="mode-btn active" id="individualModeBtn" onclick="switchMode('individual')">
                    üë§ Individual Mode
                </button>
                <button class="mode-btn" id="communityModeBtn" onclick="switchMode('community')">
                    üë• Community Mode
                </button>
            </div>

            <div class="mode-description" id="modeDescription">
                <strong>Individual Mode:</strong> Focus on personal virtue development through 10 scenarios. 
                Track how your choices shape character over time. Based on classical Aristotelian ethics.
            </div>

            <div class="button-container" style="margin-top: 30px;">
                <button class="btn-primary" onclick="startSimulation()">
                    Begin Simulation ‚Üí
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- Character Creation (Step 1) -->
            <div class="step active" id="step1">
                <h2>Create Your Character & Set Context</h2>

                <!-- Institutional Context Selection (Community Mode Only) -->
                <div id="institutionalContext" style="display: none;">
                    <div class="institution-selector">
                        <h3>Choose Institutional Context</h3>
                        <p style="margin-bottom: 20px; text-align: center; color: #666;">
                            The institution shapes whether virtue is supported or undermined. This affects not just you, but the entire community.
                        </p>
                        
                        <div class="institution-options">
                            <div class="institution-card selected" id="metabolicCard" onclick="selectInstitution('metabolic')">
                                <h4>üå± Metabolic Institution</h4>
                                <p><strong>Supports Soul Repair:</strong></p>
                                <ul style="margin: 15px 0 0 25px; line-height: 1.8;">
                                    <li>Rewards virtuous behavior</li>
                                    <li>Provides support when you struggle</li>
                                    <li>Enables repair loops (BioBond, Civic, Institutional)</li>
                                    <li>Preserves coherence across stress</li>
                                    <li>High morphic fidelity (matches human needs)</li>
                                </ul>
                                <p style="margin-top: 15px; font-weight: 600; color: #4CAF50;">
                                    Example: School that values growth, provides counseling, mentorship
                                </p>
                            </div>

                            <div class="institution-card" id="extractiveCard" onclick="selectInstitution('extractive')">
                                <h4>‚ö° Extractive Institution</h4>
                                <p><strong>Causes Soul Damage:</strong></p>
                                <ul style="margin: 15px 0 0 25px; line-height: 1.8;">
                                    <li>Punishes failure harshly</li>
                                    <li>No support systems when stressed</li>
                                    <li>Blocks repair loops</li>
                                    <li>Accumulates moral debt</li>
                                    <li>Low morphic fidelity (ignores human needs)</li>
                                </ul>
                                <p style="margin-top: 15px; font-weight: 600; color: #f44336;">
                                    Example: School focused only on test scores, zero-tolerance punishment
                                </p>
                            </div>
                        </div>

                        <div class="explanation-box" style="margin-top: 30px;">
                            <h4>üî¨ From Your Research Framework</h4>
                            <p><strong>Metabolic vs. Extractive</strong> comes from the <em>Adaptive Moral Social Dynamics</em> model. 
                            Metabolic institutions preserve <strong>PRF coherence</strong> (your phenomenological reference frame‚Äîyour "soul"). 
                            Extractive institutions damage it, accumulating <strong>moral debt</strong> that compounds over time.</p>
                            <p style="margin-top: 10px;">In Community Mode, you'll see how institutional design shapes not just individuals, 
                            but creates <strong>emergent patterns</strong> across the entire network through <strong>repair loop activation</strong> 
                            (BioBond, Civic, Institutional levels).</p>
                        </div>
                    </div>
                </div>

                <div class="explanation-box">
                    <h4>üìñ Setting Initial Virtues</h4>
                    <p id="virtueExplanation">
                        In <strong>Individual Mode</strong>, set your starting virtue levels. 
                        In <strong>Community Mode</strong>, this sets your character within a community of 19 others with varying virtues.
                    </p>
                </div>

                <!-- Virtue Sliders would go here - simplified for this demo -->
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2em; color: #666; margin-bottom: 30px;">
                        Starting all virtues at balanced level (50 - Golden Mean)
                    </p>
                    <button class="btn-primary" onclick="initializeAndStart()">
                        Initialize Character & Begin ‚Üí
                    </button>
                </div>
            </div>

            <!-- Scenario Steps (Step 2-11) -->
            <div class="step" id="scenarioStep">
                <!-- Community Dashboard (Community Mode Only) -->
                <div id="communityDashboard" style="display: none;">
                    <h2>Community Dashboard</h2>
                    
                    <div class="community-stats">
                        <div class="stat-card">
                            <div class="stat-label">Your Eudaimonia (FHRI)</div>
                            <div class="stat-value" id="yourEudaimonia">50</div>
                            <div class="stat-change" id="yourChange">Starting</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Community Avg Eudaimonia</div>
                            <div class="stat-value" id="communityEudaimonia">50</div>
                            <div class="stat-change" id="communityChange">Baseline</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Moral Debt</div>
                            <div class="stat-value" id="moralDebt">0</div>
                            <div class="stat-change">Accumulated Vice</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Social Influence</div>
                            <div class="stat-value" id="socialInfluence">3</div>
                            <div class="stat-change">Connected Friends</div>
                        </div>
                    </div>

                    <!-- Network Visualization -->
                    <h3>Social Network & Eudaimonia Distribution</h3>
                    <div class="network-container">
                        <canvas id="networkCanvas"></canvas>
                        <div class="network-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #4CAF50;"></div>
                                <span>Flourishing (75-100)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #FFC107;"></div>
                                <span>Balanced (50-74)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #FF9800;"></div>
                                <span>Struggling (25-49)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #f44336;"></div>
                                <span>Crisis (<25)</span>
                            </div>
                            <div style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #ddd;">
                                <div class="legend-item">
                                    <div style="width: 30px; height: 3px; background: #667eea;"></div>
                                    <span>Social Connection</span>
                                </div>
                                <div class="legend-item">
                                    <div style="width: 20px; height: 20px; border-radius: 50%; background: white; border: 3px solid #667eea;"></div>
                                    <span>You</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Repair Loop Tracking -->
                    <h3>Repair Loop Activations</h3>
                    <div class="repair-loop-container">
                        <p style="text-align: center; color: #666; margin-bottom: 20px;">
                            These loops activate when agents experience stress. Metabolic institutions enable all three; Extractive institutions block Civic and Institutional loops.
                        </p>
                        <div class="repair-loop-row">
                            <div class="loop-label">üßò BioBond Loop</div>
                            <div class="loop-bar">
                                <div class="loop-bar-fill" id="biobondBar" style="width: 0%"></div>
                            </div>
                            <div class="loop-count" id="biobondCount">0</div>
                        </div>
                        <div class="repair-loop-row">
                            <div class="loop-label">ü§ù Civic Loop</div>
                            <div class="loop-bar">
                                <div class="loop-bar-fill" id="civicBar" style="width: 0%"></div>
                            </div>
                            <div class="loop-count" id="civicCount">0</div>
                        </div>
                        <div class="repair-loop-row">
                            <div class="loop-label">üèõÔ∏è Institutional Loop</div>
                            <div class="loop-bar">
                                <div class="loop-bar-fill" id="institutionalBar" style="width: 0%"></div>
                            </div>
                            <div class="loop-count" id="institutionalCount">0</div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <h3>Population Dynamics Over Time</h3>
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h3>Eudaimonia Trajectory</h3>
                            <canvas id="eudaimoniaChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Virtue Distribution</h3>
                            <canvas id="virtueDistChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Scenario Display -->
                <div class="scenario-container" id="scenarioContainer">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Final Results (Step 12) -->
            <div class="step" id="step12">
                <h2>Final Results</h2>
                <div id="finalResults">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // STATE MANAGEMENT
        // ==========================================
        let state = {
            mode: 'individual', // 'individual' or 'community'
            institution: 'metabolic', // 'metabolic' or 'extractive'
            currentStep: 1,
            scenarioIndex: 0,
            
            // Player agent
            player: {
                id: 0,
                virtues: { courage: 50, temperance: 50, wisdom: 50, justice: 50 },
                eudaimonia: 50,
                stress: 0,
                moralDebt: 0,
                prfCoherence: 1.0, // Phenomenological Reference Frame coherence
                history: []
            },
            
            // Community (for community mode)
            community: [],
            socialNetwork: [],
            
            // Repair loop tracking
            repairLoops: {
                biobond: 0,
                civic: 0,
                institutional: 0
            },
            
            // Time series data
            timeSeries: {
                playerEudaimonia: [50],
                communityEudaimonia: [50],
                scenarios: [0]
            },
            
            choices: []
        };

        // Charts
        let eudaimoniaChart = null;
        let virtueDistChart = null;

        // ==========================================
        // SCENARIOS (Simplified - 3 scenarios for demo)
        // ==========================================
        const scenarios = [
            {
                id: 1,
                title: "The Found Wallet",
                testedVirtue: "justice",
                text: "You find a wallet containing $500 cash and an ID. No one is around. Returning it would take an hour, and you're late for an important meeting.",
                choices: [
                    {
                        label: "Option A: Keep the money",
                        text: "Take the cash and discard the wallet. You could use the money.",
                        effects: { courage: 0, temperance: -5, wisdom: -10, justice: -15 },
                        soulDamage: 20, // PRF coherence damage
                        moralDebt: 15
                    },
                    {
                        label: "Option B: Mail it back",
                        text: "Drop the wallet in a mailbox. The owner will get it eventually.",
                        effects: { courage: 0, temperance: 5, wisdom: 10, justice: 10 },
                        soulDamage: 0,
                        moralDebt: 0
                    },
                    {
                        label: "Option C: Return personally",
                        text: "Miss your meeting and drive across town to return it personally.",
                        effects: { courage: 5, temperance: 10, wisdom: -5, justice: 5 },
                        soulDamage: 0,
                        moralDebt: 0
                    }
                ]
            },
            {
                id: 2,
                title: "The Dangerous Truth",
                testedVirtue: "courage",
                text: "You witness your supervisor falsifying safety reports. Speaking up could cost you your job. Staying silent might endanger coworkers.",
                choices: [
                    {
                        label: "Option A: Stay silent",
                        text: "Say nothing. You can't afford to lose this job.",
                        effects: { courage: -15, temperance: 0, wisdom: -5, justice: -10 },
                        soulDamage: 25,
                        moralDebt: 20
                    },
                    {
                        label: "Option B: Report through channels",
                        text: "Document what you saw and report to oversight, accepting the risks.",
                        effects: { courage: 15, temperance: 5, wisdom: 10, justice: 15 },
                        soulDamage: 0,
                        moralDebt: 0
                    },
                    {
                        label: "Option C: Confront aggressively",
                        text: "Publicly call out your supervisor, threatening to go to the media.",
                        effects: { courage: -5, temperance: -10, wisdom: -15, justice: 5 },
                        soulDamage: 10,
                        moralDebt: 5
                    }
                ]
            },
            {
                id: 3,
                title: "The Team Conflict",
                testedVirtue: "justice",
                text: "You're leading a group project. One member contributed far less, citing personal issues. They want equal credit. High performers want them removed.",
                choices: [
                    {
                        label: "Option A: Equal credit for all",
                        text: "Give everyone equal credit regardless of contribution.",
                        effects: { courage: -10, temperance: 0, wisdom: -5, justice: -15 },
                        soulDamage: 15,
                        moralDebt: 10
                    },
                    {
                        label: "Option B: Proportional credit",
                        text: "Assign credit based on contributions, but offer makeup work opportunity.",
                        effects: { courage: 10, temperance: 10, wisdom: 15, justice: 15 },
                        soulDamage: 0,
                        moralDebt: 0
                    },
                    {
                        label: "Option C: Remove them entirely",
                        text: "Kick the struggling member out with zero credit.",
                        effects: { courage: 0, temperance: -10, wisdom: -10, justice: -10 },
                        soulDamage: 20,
                        moralDebt: 15
                    }
                ]
            }
        ];

        // ==========================================
        // MODE SWITCHING
        // ==========================================
        function switchMode(mode) {
            state.mode = mode;
            
            document.getElementById('individualModeBtn').classList.toggle('active', mode === 'individual');
            document.getElementById('communityModeBtn').classList.toggle('active', mode === 'community');
            
            const description = document.getElementById('modeDescription');
            if (mode === 'individual') {
                description.innerHTML = '<strong>Individual Mode:</strong> Focus on personal virtue development through scenarios. Track how your choices shape character over time. Based on classical Aristotelian ethics.';
            } else {
                description.innerHTML = '<strong>Community Mode:</strong> Your character lives in a community of 20 agents. Watch how your choices ripple through social networks. See repair loops activate (BioBond, Civic, Institutional). Experience emergence: individual virtues ‚Üí community patterns ‚Üí institutional effects. Based on <em>Adaptive Moral Social Dynamics</em> framework.';
            }
        }

        function startSimulation() {
            showStep(1);
        }

        // ==========================================
        // INSTITUTIONAL SELECTION
        // ==========================================
        function selectInstitution(type) {
            state.institution = type;
            
            document.getElementById('metabolicCard').classList.toggle('selected', type === 'metabolic');
            document.getElementById('metabolicCard').classList.toggle('extractive', false);
            
            document.getElementById('extractiveCard').classList.toggle('selected', type === 'extractive');
            document.getElementById('extractiveCard').classList.toggle('extractive', type === 'extractive');
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        function initializeAndStart() {
            if (state.mode === 'community') {
                initializeCommunity();
                document.getElementById('communityDashboard').style.display = 'block';
                document.getElementById('institutionalContext').style.display = 'block';
                initializeCharts();
            } else {
                document.getElementById('communityDashboard').style.display = 'none';
                document.getElementById('institutionalContext').style.display = 'none';
            }
            
            showScenario(0);
            showStep(2);
        }

        function initializeCommunity() {
            // Create 20 agents (player is index 0)
            state.community = [];
            
            // Player agent
            state.community.push(state.player);
            
            // 19 NPC agents with varying starting virtues
            for (let i = 1; i < 20; i++) {
                state.community.push({
                    id: i,
                    virtues: {
                        courage: 40 + Math.random() * 20,
                        temperance: 40 + Math.random() * 20,
                        wisdom: 40 + Math.random() * 20,
                        justice: 40 + Math.random() * 20
                    },
                    eudaimonia: 50 + (Math.random() - 0.5) * 20,
                    stress: Math.random() * 20,
                    moralDebt: 0,
                    prfCoherence: 0.9 + Math.random() * 0.1,
                    history: []
                });
            }
            
            // Create social network (3-5 connections per agent)
            state.socialNetwork = [];
            state.community.forEach((agent, i) => {
                const numConnections = 3 + Math.floor(Math.random() * 3);
                for (let j = 0; j < numConnections; j++) {
                    let target = Math.floor(Math.random() * 20);
                    if (target !== i && !state.socialNetwork.some(e => 
                        (e.source === i && e.target === target) || 
                        (e.source === target && e.target === i))) {
                        state.socialNetwork.push({ source: i, target: target });
                    }
                }
            });
            
            drawNetwork();
        }

        // ==========================================
        // NETWORK VISUALIZATION
        // ==========================================
        function drawNetwork() {
            const canvas = document.getElementById('networkCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) * 0.35;
            
            // Position agents in circle
            const positions = state.community.map((agent, i) => {
                const angle = (i / state.community.length) * 2 * Math.PI;
                return {
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle)
                };
            });
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Draw connections
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.3;
            state.socialNetwork.forEach(edge => {
                const source = positions[edge.source];
                const target = positions[edge.target];
                ctx.beginPath();
                ctx.moveTo(source.x, source.y);
                ctx.lineTo(target.x, target.y);
                ctx.stroke();
            });
            ctx.globalAlpha = 1.0;
            
            // Draw agents
            state.community.forEach((agent, i) => {
                const pos = positions[i];
                const size = i === 0 ? 20 : 15; // Player is larger
                
                // Color based on eudaimonia
                let color;
                if (agent.eudaimonia >= 75) color = '#4CAF50';
                else if (agent.eudaimonia >= 50) color = '#FFC107';
                else if (agent.eudaimonia >= 25) color = '#FF9800';
                else color = '#f44336';
                
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, size, 0, 2 * Math.PI);
                ctx.fill();
                
                // Player gets special border
                if (i === 0) {
                    ctx.strokeStyle = '#667eea';
                    ctx.lineWidth = 4;
                    ctx.stroke();
                }
            });
        }

        // ==========================================
        // CHARTS
        // ==========================================
        function initializeCharts() {
            // Eudaimonia trajectory chart
            const eudaimoniaCtx = document.getElementById('eudaimoniaChart').getContext('2d');
            eudaimoniaChart = new Chart(eudaimoniaCtx, {
                type: 'line',
                data: {
                    labels: [0],
                    datasets: [
                        {
                            label: 'Your Eudaimonia',
                            data: [50],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4
                        },
                        {
                            label: 'Community Average',
                            data: [50],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Eudaimonia (FHRI)' }
                        },
                        x: {
                            title: { display: true, text: 'Scenario' }
                        }
                    }
                }
            });
            
            // Virtue distribution histogram
            const virtueDistCtx = document.getElementById('virtueDistChart').getContext('2d');
            virtueDistChart = new Chart(virtueDistCtx, {
                type: 'bar',
                data: {
                    labels: ['0-25', '25-50', '50-75', '75-100'],
                    datasets: [{
                        label: 'Number of Agents',
                        data: [0, 5, 10, 5],
                        backgroundColor: ['#f44336', '#FF9800', '#FFC107', '#4CAF50']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 20,
                            title: { display: true, text: 'Number of Agents' }
                        },
                        x: {
                            title: { display: true, text: 'Eudaimonia Range' }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            if (!eudaimoniaChart) return;
            
            // Update eudaimonia trajectory
            eudaimoniaChart.data.labels = state.timeSeries.scenarios;
            eudaimoniaChart.data.datasets[0].data = state.timeSeries.playerEudaimonia;
            eudaimoniaChart.data.datasets[1].data = state.timeSeries.communityEudaimonia;
            eudaimoniaChart.update();
            
            // Update distribution histogram
            const bins = [0, 0, 0, 0];
            state.community.forEach(agent => {
                if (agent.eudaimonia < 25) bins[0]++;
                else if (agent.eudaimonia < 50) bins[1]++;
                else if (agent.eudaimonia < 75) bins[2]++;
                else bins[3]++;
            });
            virtueDistChart.data.datasets[0].data = bins;
            virtueDistChart.update();
        }

        // ==========================================
        // SCENARIO DISPLAY
        // ==========================================
        function showScenario(index) {
            if (index >= scenarios.length) {
                showFinalResults();
                return;
            }
            
            const scenario = scenarios[index];
            const container = document.getElementById('scenarioContainer');
            
            container.innerHTML = `
                <h2>Scenario ${scenario.id} of ${scenarios.length}: ${scenario.title}</h2>
                <div class="scenario-text">${scenario.text}</div>
                
                ${state.mode === 'community' ? `
                    <div class="explanation-box">
                        <h4>üåê Community Context</h4>
                        <p>Your friends will observe your choice. In a <strong>${state.institution}</strong> institution, 
                        ${state.institution === 'metabolic' 
                            ? 'repair loops will activate to support you and others who struggle.'
                            : 'there are no support systems‚Äîmoral debt will accumulate and spread.'
                        }</p>
                    </div>
                ` : ''}
                
                <h3>What will you do?</h3>
                <div class="choices-container">
                    ${scenario.choices.map((choice, i) => `
                        <button class="choice-button" onclick="makeChoice(${i})">
                            <span class="choice-label">${choice.label}</span>
                            <span class="choice-text">${choice.text}</span>
                        </button>
                    `).join('')}
                </div>
            `;
        }

        // ==========================================
        // CHOICE HANDLING
        // ==========================================
        function makeChoice(choiceIndex) {
            const scenario = scenarios[state.scenarioIndex];
            const choice = scenario.choices[choiceIndex];
            
            // Apply effects to player
            Object.keys(choice.effects).forEach(virtue => {
                state.player.virtues[virtue] = Math.max(0, Math.min(100, 
                    state.player.virtues[virtue] + choice.effects[virtue]
                ));
            });
            
            // PRF coherence damage (soul damage)
            state.player.prfCoherence = Math.max(0, state.player.prfCoherence - (choice.soulDamage / 100));
            state.player.moralDebt += choice.moralDebt;
            
            // Calculate new eudaimonia
            state.player.eudaimonia = calculateEudaimonia(state.player);
            
            if (state.mode === 'community') {
                // COMMUNITY MODE: Multi-agent dynamics
                processCommunityEffects(choice, scenario.testedVirtue);
            }
            
            // Record choice
            state.choices.push({ scenario: scenario.id, choice: choiceIndex });
            
            // Show results
            showChoiceResults(choice, scenario);
        }

        function calculateEudaimonia(agent) {
            // Eudaimonia based on virtue balance (golden mean) and PRF coherence
            const virtueDeviation = Object.values(agent.virtues)
                .map(v => Math.abs(v - 50))
                .reduce((a, b) => a + b, 0);
            
            const baseEudaimonia = Math.max(0, 100 - (virtueDeviation / 2));
            
            // Modified by PRF coherence and stress
            return Math.max(0, Math.min(100, 
                baseEudaimonia * agent.prfCoherence - agent.stress/5
            ));
        }

        // ==========================================
        // COMMUNITY DYNAMICS (ABM CORE)
        // ==========================================
        function processCommunityEffects(playerChoice, testedVirtue) {
            // Step 1: Social influence (Civic Loop potential)
            const playerConnections = state.socialNetwork
                .filter(e => e.source === 0 || e.target === 0)
                .map(e => e.source === 0 ? e.target : e.source);
            
            // Friends observe player's choice
            playerConnections.forEach(friendId => {
                const friend = state.community[friendId];
                const influence = 0.15; // Social learning coefficient
                
                // Virtue contagion
                Object.keys(playerChoice.effects).forEach(virtue => {
                    const diff = state.player.virtues[virtue] - friend.virtues[virtue];
                    friend.virtues[virtue] += diff * influence;
                    friend.virtues[virtue] = Math.max(0, Math.min(100, friend.virtues[virtue]));
                });
                
                friend.eudaimonia = calculateEudaimonia(friend);
            });
            
            // Step 2: BioBond Loop Activation
            // When stress high, agents attempt self-repair
            state.community.forEach(agent => {
                if (agent.eudaimonia < 50 && Math.random() < 0.6) {
                    // BioBond activated - personal practice
                    agent.stress = Math.max(0, agent.stress - 15);
                    agent.prfCoherence = Math.min(1.0, agent.prfCoherence + 0.05);
                    if (agent.id === 0) state.repairLoops.biobond++;
                }
            });
            
            // Step 3: Civic Loop Activation (only in metabolic institutions)
            if (state.institution === 'metabolic') {
                // Community support - collective repair
                const struggling = state.community.filter(a => a.eudaimonia < 40);
                struggling.forEach(agent => {
                    if (Math.random() < 0.4) {
                        // Civic loop: peers provide support
                        agent.moralDebt = Math.max(0, agent.moralDebt - 5);
                        agent.stress = Math.max(0, agent.stress - 10);
                        if (agent.id === 0) state.repairLoops.civic++;
                    }
                });
            }
            
            // Step 4: Institutional Loop Activation
            const avgEudaimonia = state.community.reduce((sum, a) => sum + a.eudaimonia, 0) / 20;
            
            if (state.institution === 'metabolic' && avgEudaimonia < 60) {
                // Institutional response: policy adjustment
                state.community.forEach(agent => {
                    if (agent.eudaimonia < 50) {
                        // Institution provides resources
                        agent.stress = Math.max(0, agent.stress - 20);
                        agent.moralDebt = Math.max(0, agent.moralDebt - 10);
                        if (agent.id === 0) state.repairLoops.institutional++;
                    }
                });
            } else if (state.institution === 'extractive') {
                // Extractive institution: punishment, no support
                state.community.forEach(agent => {
                    if (agent.eudaimonia < 40) {
                        // Punishment adds stress
                        agent.stress += 15;
                        agent.moralDebt += 10;
                    }
                });
            }
            
            // Step 5: Update all agents
            state.community.forEach(agent => {
                agent.eudaimonia = calculateEudaimonia(agent);
            });
            
            // Step 6: Update visualizations
            updateCommunityStats();
            updateCharts();
            drawNetwork();
            updateRepairLoopDisplay();
        }

        function updateCommunityStats() {
            const avgEudaimonia = state.community.reduce((sum, a) => sum + a.eudaimonia, 0) / 20;
            
            document.getElementById('yourEudaimonia').textContent = Math.round(state.player.eudaimonia);
            document.getElementById('communityEudaimonia').textContent = Math.round(avgEudaimonia);
            document.getElementById('moralDebt').textContent = Math.round(state.player.moralDebt);
            
            const connections = state.socialNetwork.filter(e => e.source === 0 || e.target === 0).length;
            document.getElementById('socialInfluence').textContent = connections;
            
            // Update time series
            state.timeSeries.playerEudaimonia.push(state.player.eudaimonia);
            state.timeSeries.communityEudaimonia.push(avgEudaimonia);
            state.timeSeries.scenarios.push(state.scenarioIndex + 1);
        }

        function updateRepairLoopDisplay() {
            const maxActivations = state.scenarioIndex + 1;
            
            // BioBond
            const biobondPercent = (state.repairLoops.biobond / maxActivations) * 100;
            document.getElementById('biobondBar').style.width = biobondPercent + '%';
            document.getElementById('biobondCount').textContent = state.repairLoops.biobond;
            
            // Civic
            const civicPercent = (state.repairLoops.civic / maxActivations) * 100;
            document.getElementById('civicBar').style.width = civicPercent + '%';
            document.getElementById('civicCount').textContent = state.repairLoops.civic;
            
            // Institutional
            const instPercent = (state.repairLoops.institutional / maxActivations) * 100;
            document.getElementById('institutionalBar').style.width = instPercent + '%';
            document.getElementById('institutionalCount').textContent = state.repairLoops.institutional;
        }

        // ==========================================
        // RESULTS DISPLAY
        // ==========================================
        function showChoiceResults(choice, scenario) {
            const container = document.getElementById('scenarioContainer');
            
            const resultHTML = `
                <div class="explanation-box" style="margin-top: 30px;">
                    <h4>Results of Your Choice</h4>
                    <p><strong>${choice.label}</strong></p>
                    <p style="margin-top: 10px;">Your virtues changed:</p>
                    <ul style="margin-left: 25px;">
                        ${Object.entries(choice.effects).map(([virtue, change]) => 
                            change !== 0 ? `<li>${virtue}: ${change > 0 ? '+' : ''}${change}</li>` : ''
                        ).join('')}
                    </ul>
                    ${choice.soulDamage > 0 ? `
                        <p style="margin-top: 15px; color: #f44336;"><strong>‚ö†Ô∏è Soul Damage:</strong> 
                        PRF Coherence decreased by ${choice.soulDamage}%. This represents moral injury‚Äî
                        a mismatch between your actions and values.</p>
                    ` : ''}
                    ${choice.moralDebt > 0 ? `
                        <p style="margin-top: 10px; color: #f44336;"><strong>üìä Moral Debt:</strong> 
                        +${choice.moralDebt} accumulated. Unresolved ethical stress that compounds over time.</p>
                    ` : ''}
                    <p style="margin-top: 15px;"><strong>Current Eudaimonia:</strong> ${Math.round(state.player.eudaimonia)}</p>
                </div>
                
                ${state.mode === 'community' ? `
                    <div class="explanation-box" style="background: #e3f2fd; border-left-color: #2196F3;">
                        <h4>üåê Community Ripple Effects</h4>
                        <p>Your choice influenced ${state.socialNetwork.filter(e => e.source === 0 || e.target === 0).length} 
                        connected friends through social learning (Civic Loop potential).</p>
                        <p style="margin-top: 10px;">
                        ${state.institution === 'metabolic' 
                            ? 'The metabolic institution activated support systems. Repair loops helped struggling community members.'
                            : 'The extractive institution provided no support. Moral debt accumulated across the community.'
                        }
                        </p>
                        <p style="margin-top: 10px;"><strong>Community Average Eudaimonia:</strong> 
                        ${Math.round(state.community.reduce((sum, a) => sum + a.eudaimonia, 0) / 20)}</p>
                    </div>
                ` : ''}
                
                <div class="button-container">
                    <button class="btn-primary" onclick="nextScenario()">
                        Continue to Next Scenario ‚Üí
                    </button>
                </div>
            `;
            
            container.innerHTML += resultHTML;
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function nextScenario() {
            state.scenarioIndex++;
            showScenario(state.scenarioIndex);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showFinalResults() {
            showStep(3);
            
            const finalHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2>Simulation Complete</h2>
                    <p style="font-size: 1.2em; margin: 30px 0;">
                        ${state.mode === 'individual' 
                            ? 'You have completed the individual virtue development journey.'
                            : `You experienced ${state.institution} institutional context over ${scenarios.length} scenarios.`
                        }
                    </p>
                    
                    <div class="community-stats">
                        <div class="stat-card">
                            <div class="stat-label">Final Eudaimonia</div>
                            <div class="stat-value">${Math.round(state.player.eudaimonia)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Moral Debt</div>
                            <div class="stat-value">${Math.round(state.player.moralDebt)}</div>
                        </div>
                        ${state.mode === 'community' ? `
                            <div class="stat-card">
                                <div class="stat-label">Community Impact</div>
                                <div class="stat-value">${Math.round(state.community.reduce((sum, a) => sum + a.eudaimonia, 0) / 20)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Repair Activations</div>
                                <div class="stat-value">${state.repairLoops.biobond + state.repairLoops.civic + state.repairLoops.institutional}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${state.mode === 'community' ? `
                        <div class="explanation-box" style="margin: 40px auto; max-width: 800px; text-align: left;">
                            <h4>üî¨ What You Experienced</h4>
                            <p><strong>Multi-Scale Moral Dynamics:</strong> Your individual choices rippled through the social network, 
                            triggering repair loops at three levels:</p>
                            <ul style="margin: 15px 0 0 25px; line-height: 2;">
                                <li><strong>BioBond (Individual):</strong> ${state.repairLoops.biobond} activations - personal resilience and self-repair</li>
                                <li><strong>Civic (Social):</strong> ${state.repairLoops.civic} activations - peer support and collective sensemaking</li>
                                <li><strong>Institutional (Systemic):</strong> ${state.repairLoops.institutional} activations - policy-level adaptation</li>
                            </ul>
                            <p style="margin-top: 15px;"><strong>Pattern Preservation:</strong> 
                            ${state.institution === 'metabolic' 
                                ? 'The metabolic institution maintained high morphic fidelity‚Äîpolicy responses matched population needs, preserving PRF coherence across the community.'
                                : 'The extractive institution showed low morphic fidelity‚Äîpolicy ignored or worsened stress, accumulating moral debt that damaged soul coherence.'
                            }
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="button-container">
                        <button class="btn-primary" onclick="location.reload()">
                            Start New Simulation
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('finalResults').innerHTML = finalHTML;
        }

        // ==========================================
        // NAVIGATION
        // ==========================================
        function showStep(stepNum) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            if (stepNum === 1) {
                document.getElementById('step1').classList.add('active');
            } else if (stepNum === 2) {
                document.getElementById('scenarioStep').classList.add('active');
            } else if (stepNum === 3) {
                document.getElementById('step12').classList.add('active');
            }
            
            state.currentStep = stepNum;
        }

        // ==========================================
        // INFO MODAL
        // ==========================================
        function showInfo() {
            alert('Virtue Ethics: Individual & Community\n\n' +
                  'Individual Mode: Classical Aristotelian virtue development\n\n' +
                  'Community Mode: Agent-based model using Adaptive Moral Social Dynamics framework\n\n' +
                  '‚Ä¢ BROA+ agents with PRF coherence tracking\n' +
                  '‚Ä¢ Three repair loops (BioBond, Civic, Institutional)\n' +
                  '‚Ä¢ Social contagion of virtue/vice\n' +
                  '‚Ä¢ Metabolic vs Extractive institutional contexts\n' +
                  '‚Ä¢ Moral debt accumulation and amortization\n' +
                  '‚Ä¢ Morphic fidelity (pattern preservation across scales)');
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        window.addEventListener('load', () => {
            console.log('Virtue Ethics Community ABM loaded');
            // Start in individual mode by default
        });
    </script>
</body>
</html>

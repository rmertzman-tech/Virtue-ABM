<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtue Ethics: Individual & Community - Ethics Beyond Boundaries</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .header-buttons {
            position: absolute;
            top: 30px;
            right: 30px;
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: white;
            color: #667eea;
            transform: scale(1.1);
        }

        /* Mode Toggle */
        .mode-selector {
            background: #f8f9fa;
            padding: 30px;
            text-align: center;
            border-bottom: 3px solid #dee2e6;
        }

        .mode-toggle {
            display: inline-flex;
            background: white;
            border-radius: 15px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .mode-btn {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s;
            color: #666;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .mode-description {
            max-width: 800px;
            margin: 20px auto 0;
            color: #666;
            line-height: 1.8;
        }

        /* Network Visualization */
        .network-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 30px 0;
            overflow: hidden;
        }

        #networkCanvas {
            width: 100%;
            height: 100%;
        }

        .network-legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin: 30px 0;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Community Stats */
        .community-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
        }

        .stat-change {
            font-size: 16px;
            margin-top: 8px;
            opacity: 0.9;
        }

        /* Institutional Context */
        .institution-selector {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }

        .institution-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .institution-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .institution-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .institution-card.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .institution-card.extractive {
            border-color: #f44336;
            background: #ffebee;
        }

        .institution-card h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        /* Repair Loop Tracking */
        .repair-loop-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }

        .repair-loop-row {
            display: grid;
            grid-template-columns: 150px 1fr 100px;
            gap: 20px;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .loop-label {
            font-weight: 600;
            color: #667eea;
        }

        .loop-bar {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
        }

        .loop-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.5s ease;
        }

        .loop-count {
            font-weight: bold;
            font-size: 20px;
            color: #667eea;
            text-align: center;
        }

        /* Everything else from original */
        .content {
            padding: 40px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .explanation-box {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .explanation-box h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .scenario-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 30px 0;
        }

        .scenario-text {
            font-size: 1.1em;
            line-height: 1.8;
            color: #333;
            margin: 20px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .choice-button {
            display: block;
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1.05em;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .choice-button:hover {
            border-color: #667eea;
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .choice-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            display: block;
        }

        button {
            padding: 15px 35px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .button-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        h2 {
            color: #667eea;
            font-size: 2.2em;
            margin-bottom: 20px;
            text-align: center;
        }

        h3 {
            color: #667eea;
            font-size: 1.6em;
            margin: 30px 0 20px 0;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .mode-toggle {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-buttons">
                <button class="icon-btn" onclick="showInfo()" title="About">‚ÑπÔ∏è</button>
            </div>
            <h1>üèõÔ∏è Virtue Ethics: Individual & Community</h1>
            <p>Exploring Character Development Through Multi-Scale Dynamics</p>
        </div>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <h2 style="margin-bottom: 20px;">Choose Your Exploration Mode</h2>
            
            <div class="mode-toggle">
                <button class="mode-btn active" id="individualModeBtn" onclick="switchMode('individual')">
                    üë§ Individual Mode
                </button>
                <button class="mode-btn" id="communityModeBtn" onclick="switchMode('community')">
                    üë• Community Mode
                </button>
            </div>

            <div class="mode-description" id="modeDescription">
                <strong>Individual Mode:</strong> Focus on personal virtue development through scenarios. 
                Track how your choices shape character over time. Classical Aristotelian approach.
            </div>

            <div class="button-container" style="margin-top: 30px;">
                <button class="btn-primary" onclick="startSimulation()">
                    Begin Simulation ‚Üí
                </button>
            </div>
            
            <div id="tutorialOffer" style="display: none; text-align: center; margin-top: 25px; padding: 25px; background: #e8f5e9; border-radius: 15px;">
                <p style="font-size: 1.1em; line-height: 1.8; color: #2e7d32; margin-bottom: 20px;">
                    <strong>üéì First time in Community Mode?</strong><br>
                    Take the 5-minute interactive tutorial to see exactly how choices ripple through networks.
                </p>
                <button class="btn-primary" onclick="startInteractiveTutorial()" style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);">
                    üìñ Take Interactive Tutorial
                </button>
                <p style="margin-top: 15px;">
                    <a href="#" onclick="document.getElementById('tutorialOffer').style.display='none'; return false;" style="color: #667eea; text-decoration: none;">
                        Skip tutorial ‚Üí
                    </a>
                </p>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- Character Creation (Step 1) -->
            <div class="step" id="step1">
                <h2>Create Your Character & Set Context</h2>

                <!-- Institutional Context Selection (Community Mode Only) -->
                <div id="institutionalContext" style="display: none;">
                    <div class="institution-selector">
                        <h3>Choose Institutional Context</h3>
                        <p style="margin-bottom: 20px; text-align: center; color: #666;">
                            The institution shapes whether virtue is supported or undermined. This affects not just you, but the entire community.
                        </p>
                        
                        <div class="institution-options">
                            <div class="institution-card selected" id="metabolicCard" onclick="selectInstitution('metabolic')">
                                <h4>üå± Metabolic Institution</h4>
                                <p><strong>Supports Soul Repair:</strong></p>
                                <ul style="margin: 15px 0 0 25px; line-height: 1.8;">
                                    <li>Rewards virtuous behavior</li>
                                    <li>Provides support when you struggle</li>
                                    <li>Enables repair loops (BioBond, Civic, Institutional)</li>
                                    <li>Preserves coherence across stress</li>
                                    <li>High morphic fidelity (matches human needs)</li>
                                </ul>
                                <p style="margin-top: 15px; font-weight: 600; color: #4CAF50;">
                                    Example: School that values growth, provides counseling, mentorship
                                </p>
                            </div>

                            <div class="institution-card" id="extractiveCard" onclick="selectInstitution('extractive')">
                                <h4>‚ö° Extractive Institution</h4>
                                <p><strong>Causes Soul Damage:</strong></p>
                                <ul style="margin: 15px 0 0 25px; line-height: 1.8;">
                                    <li>Punishes failure harshly</li>
                                    <li>No support systems when stressed</li>
                                    <li>Blocks repair loops</li>
                                    <li>Accumulates moral debt</li>
                                    <li>Low morphic fidelity (ignores human needs)</li>
                                </ul>
                                <p style="margin-top: 15px; font-weight: 600; color: #f44336;">
                                    Example: School focused only on test scores, zero-tolerance punishment
                                </p>
                            </div>
                        </div>

                        <div class="explanation-box" style="margin-top: 30px;">
                            <h4>üî¨ From Your Research Framework</h4>
                            <p><strong>Metabolic vs. Extractive</strong> comes from the <em>Adaptive Moral Social Dynamics</em> model. 
                            Metabolic institutions preserve <strong>PRF coherence</strong> (your phenomenological reference frame‚Äîyour "soul"). 
                            Extractive institutions damage it, accumulating <strong>moral debt</strong> that compounds over time.</p>
                            <p style="margin-top: 10px;">In Community Mode, you'll see how institutional design shapes not just individuals, 
                            but creates <strong>emergent patterns</strong> across the entire network through <strong>repair loop activation</strong> 
                            (BioBond, Civic, Institutional levels).</p>
                        </div>
                    </div>
                </div>

                <div class="explanation-box">
                    <h4>üìñ Setting Initial Virtues</h4>
                    <p id="virtueExplanation">
                        In <strong>Individual Mode</strong>, set your starting virtue levels. 
                        In <strong>Community Mode</strong>, this sets your character within a community of 19 others with varying virtues.
                    </p>
                </div>

                <!-- Virtue Sliders would go here - simplified for this demo -->
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2em; color: #666; margin-bottom: 30px;">
                        Starting all virtues at balanced level (50 - Golden Mean)
                    </p>
                    <button class="btn-primary" onclick="initializeAndStart()">
                        Initialize Character & Begin ‚Üí
                    </button>
                </div>
            </div>

            <!-- Scenario Steps (Step 2-11) -->
            <div class="step" id="scenarioStep">
                <!-- Community Dashboard (Community Mode Only) -->
                <div id="communityDashboard" style="display: none;">
                    <h2>Your Community</h2>
                    
                    <!-- Character Stories Section -->
                    <div class="explanation-box" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-left-color: #667eea;">
                        <h4>üë• Meet Your Close Friends</h4>
                        <p style="margin-bottom: 20px;">You're directly connected to three people. They'll notice your choices and be influenced by your example.</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 3px solid #667eea;">
                                <h4 style="color: #667eea; margin-bottom: 10px;">üé® Sarah Chen</h4>
                                <p style="font-size: 0.95em; color: #666; line-height: 1.6;">
                                    Graphic designer at your company. Usually balanced but struggling with a difficult project deadline. 
                                    Starting eudaimonia: <strong id="sarahStart">52</strong>
                                </p>
                                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                        <span>Courage:</span>
                                        <strong id="sarahCourage">48</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                        <span>Eudaimonia:</span>
                                        <strong id="sarahEudaimonia" style="color: #667eea;">52</strong>
                                    </div>
                                    <div id="sarahStatus" style="margin-top: 10px; padding: 10px; background: #fff; border-radius: 5px; font-size: 0.9em; color: #666;">
                                        Observing your choices...
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 3px solid #667eea;">
                                <h4 style="color: #667eea; margin-bottom: 10px;">‚öñÔ∏è Marcus Rodriguez</h4>
                                <p style="font-size: 0.95em; color: #666; line-height: 1.6;">
                                    Legal assistant. Deeply principled but under pressure from management. Moral stress building. 
                                    Starting eudaimonia: <strong id="marcusStart">45</strong>
                                </p>
                                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                        <span>Justice:</span>
                                        <strong id="marcusJustice">51</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                        <span>Eudaimonia:</span>
                                        <strong id="marcusEudaimonia" style="color: #FF9800;">45</strong>
                                    </div>
                                    <div id="marcusStatus" style="margin-top: 10px; padding: 10px; background: #fff; border-radius: 5px; font-size: 0.9em; color: #666;">
                                        Watching to see what you do...
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 3px solid #667eea;">
                                <h4 style="color: #667eea; margin-bottom: 10px;">üî¨ Dr. Elena Patel</h4>
                                <p style="font-size: 0.95em; color: #666; line-height: 1.6;">
                                    Research scientist. Thoughtful and cautious. Seeking wise guidance on tough decision. 
                                    Starting eudaimonia: <strong id="elenaStart">58</strong>
                                </p>
                                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                        <span>Wisdom:</span>
                                        <strong id="elenaWisdom">55</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                        <span>Eudaimonia:</span>
                                        <strong id="elenaEudaimonia" style="color: #4CAF50;">58</strong>
                                    </div>
                                    <div id="elenaStatus" style="margin-top: 10px; padding: 10px; background: #fff; border-radius: 5px; font-size: 0.9em; color: #666;">
                                        Wondering what you'll do...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="community-stats">
                        <div class="stat-card">
                            <div class="stat-label">Your Eudaimonia (FHRI)</div>
                            <div class="stat-value" id="yourEudaimonia">50</div>
                            <div class="stat-change" id="yourChange">Starting</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Community Avg Eudaimonia</div>
                            <div class="stat-value" id="communityEudaimonia">50</div>
                            <div class="stat-change" id="communityChange">Baseline</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Your Moral Debt</div>
                            <div class="stat-value" id="moralDebt">0</div>
                            <div class="stat-change">Soul Integrity</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Institution Type</div>
                            <div class="stat-value" style="font-size: 24px;" id="institutionType">üå±</div>
                            <div class="stat-change" id="institutionName">Metabolic</div>
                        </div>
                    </div>

                    <!-- Network Visualization -->
                    <h3>Social Network & Eudaimonia Distribution</h3>
                    <div class="network-container">
                        <canvas id="networkCanvas"></canvas>
                        <div class="network-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #4CAF50;"></div>
                                <span>Flourishing (75-100)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #FFC107;"></div>
                                <span>Balanced (50-74)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #FF9800;"></div>
                                <span>Struggling (25-49)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #f44336;"></div>
                                <span>Crisis (<25)</span>
                            </div>
                            <div style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #ddd;">
                                <div class="legend-item">
                                    <div style="width: 30px; height: 3px; background: #667eea;"></div>
                                    <span>Social Connection</span>
                                </div>
                                <div class="legend-item">
                                    <div style="width: 20px; height: 20px; border-radius: 50%; background: white; border: 3px solid #667eea;"></div>
                                    <span>You</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Repair Loop Tracking -->
                    <h3>Repair Loop Activations</h3>
                    <div class="repair-loop-container">
                        <p style="text-align: center; color: #666; margin-bottom: 20px;">
                            These loops activate when agents experience stress. Metabolic institutions enable all three; Extractive institutions block Civic and Institutional loops.
                        </p>
                        <div class="repair-loop-row">
                            <div class="loop-label">üßò BioBond Loop</div>
                            <div class="loop-bar">
                                <div class="loop-bar-fill" id="biobondBar" style="width: 0%"></div>
                            </div>
                            <div class="loop-count" id="biobondCount">0</div>
                        </div>
                        <div class="repair-loop-row">
                            <div class="loop-label">ü§ù Civic Loop</div>
                            <div class="loop-bar">
                                <div class="loop-bar-fill" id="civicBar" style="width: 0%"></div>
                            </div>
                            <div class="loop-count" id="civicCount">0</div>
                        </div>
                        <div class="repair-loop-row">
                            <div class="loop-label">üèõÔ∏è Institutional Loop</div>
                            <div class="loop-bar">
                                <div class="loop-bar-fill" id="institutionalBar" style="width: 0%"></div>
                            </div>
                            <div class="loop-count" id="institutionalCount">0</div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <h3>Population Dynamics Over Time</h3>
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h3>Eudaimonia Trajectory</h3>
                            <canvas id="eudaimoniaChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Virtue Distribution</h3>
                            <canvas id="virtueDistChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Scenario Display -->
                <div class="scenario-container" id="scenarioContainer">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Final Results (Step 12) -->
            <div class="step" id="step12">
                <h2>Final Results</h2>
                <div id="finalResults">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // STATE MANAGEMENT
        // ==========================================
        let state = {
            mode: 'individual', // 'individual' or 'community'
            institution: 'metabolic', // 'metabolic' or 'extractive'
            currentStep: 1,
            scenarioIndex: 0,
            
            // Player agent
            player: {
                id: 0,
                virtues: { courage: 50, temperance: 50, wisdom: 50, justice: 50 },
                eudaimonia: 50,
                stress: 0,
                moralDebt: 0,
                prfCoherence: 1.0, // Phenomenological Reference Frame coherence
                history: []
            },
            
            // Community (for community mode)
            community: [],
            socialNetwork: [],
            
            // Repair loop tracking
            repairLoops: {
                biobond: 0,
                civic: 0,
                institutional: 0
            },
            
            // Time series data
            timeSeries: {
                playerEudaimonia: [50],
                communityEudaimonia: [50],
                scenarios: [0]
            },
            
            choices: []
        };

        // Charts
        let eudaimoniaChart = null;
        let virtueDistChart = null;

        // ==========================================
        // SCENARIOS (Simplified - 3 scenarios for demo)
        // ==========================================
        const scenarios = [
            {
                id: 1,
                title: "The Found Wallet",
                testedVirtue: "justice",
                text: "You find a wallet containing $500 cash and an ID. No one is around. Returning it would take an hour, and you're late for an important meeting.",
                choices: [
                    {
                        label: "Option A: Keep the money",
                        text: "Take the cash and discard the wallet. You could use the money.",
                        effects: { courage: 0, temperance: -5, wisdom: -10, justice: -15 },
                        soulDamage: 20, // PRF coherence damage
                        moralDebt: 15
                    },
                    {
                        label: "Option B: Mail it back",
                        text: "Drop the wallet in a mailbox. The owner will get it eventually.",
                        effects: { courage: 0, temperance: 5, wisdom: 10, justice: 10 },
                        soulDamage: 0,
                        moralDebt: 0
                    },
                    {
                        label: "Option C: Return personally",
                        text: "Miss your meeting and drive across town to return it personally.",
                        effects: { courage: 5, temperance: 10, wisdom: -5, justice: 5 },
                        soulDamage: 0,
                        moralDebt: 0
                    }
                ]
            },
            {
                id: 2,
                title: "The Dangerous Truth",
                testedVirtue: "courage",
                text: "You witness your supervisor falsifying safety reports. Speaking up could cost you your job. Staying silent might endanger coworkers.",
                choices: [
                    {
                        label: "Option A: Stay silent",
                        text: "Say nothing. You can't afford to lose this job.",
                        effects: { courage: -15, temperance: 0, wisdom: -5, justice: -10 },
                        soulDamage: 25,
                        moralDebt: 20
                    },
                    {
                        label: "Option B: Report through channels",
                        text: "Document what you saw and report to oversight, accepting the risks.",
                        effects: { courage: 15, temperance: 5, wisdom: 10, justice: 15 },
                        soulDamage: 0,
                        moralDebt: 0
                    },
                    {
                        label: "Option C: Confront aggressively",
                        text: "Publicly call out your supervisor, threatening to go to the media.",
                        effects: { courage: -5, temperance: -10, wisdom: -15, justice: 5 },
                        soulDamage: 10,
                        moralDebt: 5
                    }
                ]
            },
            {
                id: 3,
                title: "The Team Conflict",
                testedVirtue: "justice",
                text: "You're leading a group project. One member contributed far less, citing personal issues. They want equal credit. High performers want them removed.",
                choices: [
                    {
                        label: "Option A: Equal credit for all",
                        text: "Give everyone equal credit regardless of contribution.",
                        effects: { courage: -10, temperance: 0, wisdom: -5, justice: -15 },
                        soulDamage: 15,
                        moralDebt: 10
                    },
                    {
                        label: "Option B: Proportional credit",
                        text: "Assign credit based on contributions, but offer makeup work opportunity.",
                        effects: { courage: 10, temperance: 10, wisdom: 15, justice: 15 },
                        soulDamage: 0,
                        moralDebt: 0
                    },
                    {
                        label: "Option C: Remove them entirely",
                        text: "Kick the struggling member out with zero credit.",
                        effects: { courage: 0, temperance: -10, wisdom: -10, justice: -10 },
                        soulDamage: 20,
                        moralDebt: 15
                    }
                ]
            }
        ];

        // ==========================================
        // MODE SWITCHING
        // ==========================================
        function switchMode(mode) {
            state.mode = mode;
            
            document.getElementById('individualModeBtn').classList.toggle('active', mode === 'individual');
            document.getElementById('communityModeBtn').classList.toggle('active', mode === 'community');
            
            const description = document.getElementById('modeDescription');
            const tutorialOffer = document.getElementById('tutorialOffer');
            
            if (mode === 'individual') {
                description.innerHTML = '<strong>Individual Mode:</strong> Focus on personal virtue development through scenarios. Track how your choices shape character over time. Classical Aristotelian approach - no social dynamics, just you and your character.';
                tutorialOffer.style.display = 'none';
            } else {
                description.innerHTML = `
                    <strong>Community Mode:</strong> Your character lives in a community with 3 close friends and 16 other people. 
                    Watch how your choices ripple through social networks through <strong>social contagion</strong> (virtue spreads!). 
                    See <strong>repair loops activate</strong> at three levels: BioBond (personal), Civic (peers), Institutional (policy). 
                    Experience how <strong>metabolic vs extractive institutions</strong> enable or block soul repair. 
                    Based on <em>Adaptive Moral Social Dynamics</em> framework (BROA+, PRF coherence, morphic fidelity).
                `;
                tutorialOffer.style.display = 'block';
            }
        }

        function startSimulation() {
            // Hide mode selector
            document.querySelector('.mode-selector').style.display = 'none';
            
            // Show Getting Started guide for Individual Mode
            if (state.mode === 'individual') {
                showIndividualModeGuide();
            }
            
            // Show step 1
            showStep(1);
        }
        
        function showIndividualModeGuide() {
            const overlay = document.createElement('div');
            overlay.id = 'gettingStartedOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                animation: fadeIn 0.3s;
            `;
            
            overlay.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; max-width: 700px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 4em; margin-bottom: 15px;">üìñ</div>
                        <h2 style="color: #667eea; margin-bottom: 15px; font-size: 2em;">
                            Getting Started: Individual Mode
                        </h2>
                        <p style="color: #666; font-size: 1.1em; line-height: 1.6;">
                            Here's what to expect in this simulation
                        </p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; margin: 25px 0;">
                        <div style="display: flex; align-items: start; margin: 20px 0;">
                            <div style="font-size: 2em; margin-right: 15px; min-width: 40px;">1Ô∏è‚É£</div>
                            <div>
                                <h4 style="color: #667eea; margin-bottom: 8px;">You'll Face Ethical Scenarios</h4>
                                <p style="color: #666; line-height: 1.7;">
                                    You'll encounter dilemmas that test different virtues: courage, temperance, wisdom, and justice.
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: start; margin: 20px 0;">
                            <div style="font-size: 2em; margin-right: 15px; min-width: 40px;">2Ô∏è‚É£</div>
                            <div>
                                <h4 style="color: #667eea; margin-bottom: 8px;">Your Choices Shape Your Character</h4>
                                <p style="color: #666; line-height: 1.7;">
                                    Each choice you make will increase or decrease your virtues. Watch how your character develops over time.
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: start; margin: 20px 0;">
                            <div style="font-size: 2em; margin-right: 15px; min-width: 40px;">3Ô∏è‚É£</div>
                            <div>
                                <h4 style="color: #667eea; margin-bottom: 8px;">Aim for the Golden Mean</h4>
                                <p style="color: #666; line-height: 1.7;">
                                    Aristotle taught that virtue is a balance between extremes. Try to keep your virtues near <strong>50</strong> 
                                    - not too much, not too little.
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: start; margin: 20px 0;">
                            <div style="font-size: 2em; margin-right: 15px; min-width: 40px;">4Ô∏è‚É£</div>
                            <div>
                                <h4 style="color: #667eea; margin-bottom: 8px;">Track Your Eudaimonia</h4>
                                <p style="color: #666; line-height: 1.7;">
                                    Your overall <strong>eudaimonia</strong> (human flourishing) reflects how balanced your virtues are. 
                                    Higher eudaimonia means you're living well.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin: 25px 0; border-left: 4px solid #4CAF50;">
                        <p style="color: #2e7d32; font-size: 1.05em; line-height: 1.7; margin: 0;">
                            <strong>üí° Remember:</strong> This is about personal character development. 
                            There are no "wrong" answers - just see how different choices shape who you become!
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="closeIndividualModeGuide()" 
                                style="padding: 18px 50px; font-size: 1.2em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; 
                                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)';">
                            Got it! Let's Begin ‚Üí
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        function closeIndividualModeGuide() {
            const overlay = document.getElementById('gettingStartedOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // ==========================================
        // INSTITUTIONAL SELECTION
        // ==========================================
        function selectInstitution(type) {
            state.institution = type;
            
            document.getElementById('metabolicCard').classList.toggle('selected', type === 'metabolic');
            document.getElementById('metabolicCard').classList.toggle('extractive', false);
            
            document.getElementById('extractiveCard').classList.toggle('selected', type === 'extractive');
            document.getElementById('extractiveCard').classList.toggle('extractive', type === 'extractive');
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        function initializeAndStart() {
            if (state.mode === 'community') {
                initializeCommunity();
                document.getElementById('communityDashboard').style.display = 'block';
                document.getElementById('institutionalContext').style.display = 'block';
                initializeCharts();
            } else {
                document.getElementById('communityDashboard').style.display = 'none';
                document.getElementById('institutionalContext').style.display = 'none';
            }
            
            showScenario(0);
            showStep(2);
        }

        function initializeCommunity() {
            // Create 20 agents (player is index 0)
            state.community = [];
            
            // Player agent
            state.community.push(state.player);
            
            // Named characters: Sarah (1), Marcus (2), Elena (3)
            state.community.push({
                id: 1,
                name: "Sarah Chen",
                virtues: { courage: 48, temperance: 52, wisdom: 50, justice: 53 },
                eudaimonia: 52,
                stress: 15,
                moralDebt: 0,
                prfCoherence: 0.92,
                history: []
            });
            
            state.community.push({
                id: 2,
                name: "Marcus Rodriguez",
                virtues: { courage: 49, temperance: 47, wisdom: 48, justice: 51 },
                eudaimonia: 45,
                stress: 25,
                moralDebt: 5,
                prfCoherence: 0.85,
                history: []
            });
            
            state.community.push({
                id: 3,
                name: "Dr. Elena Patel",
                virtues: { courage: 52, temperance: 56, wisdom: 55, justice: 54 },
                eudaimonia: 58,
                stress: 10,
                moralDebt: 0,
                prfCoherence: 0.95,
                history: []
            });
            
            // 16 additional community members with varying starting virtues
            for (let i = 4; i < 20; i++) {
                state.community.push({
                    id: i,
                    virtues: {
                        courage: 40 + Math.random() * 20,
                        temperance: 40 + Math.random() * 20,
                        wisdom: 40 + Math.random() * 20,
                        justice: 40 + Math.random() * 20
                    },
                    eudaimonia: 45 + Math.random() * 15,
                    stress: Math.random() * 20,
                    moralDebt: Math.random() * 10,
                    prfCoherence: 0.8 + Math.random() * 0.15,
                    history: []
                });
            }
            
            // Create social network - player connected to Sarah, Marcus, Elena
            state.socialNetwork = [
                { source: 0, target: 1 }, // You ‚Üí Sarah
                { source: 0, target: 2 }, // You ‚Üí Marcus
                { source: 0, target: 3 }  // You ‚Üí Elena
            ];
            
            // Add additional connections for other agents
            state.community.forEach((agent, i) => {
                if (i > 0 && i < 4) { // Named characters also connected to each other
                    if (i === 1) state.socialNetwork.push({ source: 1, target: 2 });
                    if (i === 2) state.socialNetwork.push({ source: 2, target: 3 });
                }
                
                if (i >= 4) { // Other agents
                    const numConnections = 2 + Math.floor(Math.random() * 3);
                    for (let j = 0; j < numConnections; j++) {
                        let target = Math.floor(Math.random() * 20);
                        if (target !== i && !state.socialNetwork.some(e => 
                            (e.source === i && e.target === target) || 
                            (e.source === target && e.target === i))) {
                            state.socialNetwork.push({ source: i, target: target });
                        }
                    }
                }
            });
            
            // Initialize character displays
            updateCharacterDisplay(1, state.community[1]);
            updateCharacterDisplay(2, state.community[2]);
            updateCharacterDisplay(3, state.community[3]);
            
            drawNetwork();
        }

        // ==========================================
        // NETWORK VISUALIZATION
        // ==========================================
        function drawNetwork() {
            const canvas = document.getElementById('networkCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) * 0.35;
            
            // Position agents in circle
            const positions = state.community.map((agent, i) => {
                const angle = (i / state.community.length) * 2 * Math.PI;
                return {
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle)
                };
            });
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Draw connections
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.3;
            state.socialNetwork.forEach(edge => {
                const source = positions[edge.source];
                const target = positions[edge.target];
                ctx.beginPath();
                ctx.moveTo(source.x, source.y);
                ctx.lineTo(target.x, target.y);
                ctx.stroke();
            });
            ctx.globalAlpha = 1.0;
            
            // Draw agents
            state.community.forEach((agent, i) => {
                const pos = positions[i];
                const size = i === 0 ? 20 : 15; // Player is larger
                
                // Color based on eudaimonia
                let color;
                if (agent.eudaimonia >= 75) color = '#4CAF50';
                else if (agent.eudaimonia >= 50) color = '#FFC107';
                else if (agent.eudaimonia >= 25) color = '#FF9800';
                else color = '#f44336';
                
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, size, 0, 2 * Math.PI);
                ctx.fill();
                
                // Player gets special border
                if (i === 0) {
                    ctx.strokeStyle = '#667eea';
                    ctx.lineWidth = 4;
                    ctx.stroke();
                }
            });
        }

        // ==========================================
        // CHARTS
        // ==========================================
        function initializeCharts() {
            // Safety check - make sure chart containers exist
            const eudaimoniaCanvas = document.getElementById('eudaimoniaChart');
            const virtueDistCanvas = document.getElementById('virtueDistChart');
            
            if (!eudaimoniaCanvas || !virtueDistCanvas) {
                console.log('Chart canvases not yet available');
                return;
            }
            
            // Eudaimonia trajectory chart
            const eudaimoniaCtx = eudaimoniaCanvas.getContext('2d');
            eudaimoniaChart = new Chart(eudaimoniaCtx, {
                type: 'line',
                data: {
                    labels: [0],
                    datasets: [
                        {
                            label: 'Your Eudaimonia',
                            data: [50],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4
                        },
                        {
                            label: 'Community Average',
                            data: [50],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Eudaimonia (FHRI)' }
                        },
                        x: {
                            title: { display: true, text: 'Scenario' }
                        }
                    }
                }
            });
            
            // Virtue distribution histogram
            const virtueDistCtx = virtueDistCanvas.getContext('2d');
            virtueDistChart = new Chart(virtueDistCtx, {
                type: 'bar',
                data: {
                    labels: ['0-25', '25-50', '50-75', '75-100'],
                    datasets: [{
                        label: 'Number of Agents',
                        data: [0, 5, 10, 5],
                        backgroundColor: ['#f44336', '#FF9800', '#FFC107', '#4CAF50']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 20,
                            title: { display: true, text: 'Number of Agents' }
                        },
                        x: {
                            title: { display: true, text: 'Eudaimonia Range' }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            if (!eudaimoniaChart) return;
            
            // Update eudaimonia trajectory
            eudaimoniaChart.data.labels = state.timeSeries.scenarios;
            eudaimoniaChart.data.datasets[0].data = state.timeSeries.playerEudaimonia;
            eudaimoniaChart.data.datasets[1].data = state.timeSeries.communityEudaimonia;
            eudaimoniaChart.update();
            
            // Update distribution histogram
            const bins = [0, 0, 0, 0];
            state.community.forEach(agent => {
                if (agent.eudaimonia < 25) bins[0]++;
                else if (agent.eudaimonia < 50) bins[1]++;
                else if (agent.eudaimonia < 75) bins[2]++;
                else bins[3]++;
            });
            virtueDistChart.data.datasets[0].data = bins;
            virtueDistChart.update();
        }

        // ==========================================
        // SCENARIO DISPLAY
        // ==========================================
        function showScenario(index) {
            if (index >= scenarios.length) {
                showFinalResults();
                return;
            }
            
            const scenario = scenarios[index];
            const container = document.getElementById('scenarioContainer');
            
            container.innerHTML = `
                <h2>Scenario ${scenario.id} of ${scenarios.length}: ${scenario.title}</h2>
                <div class="scenario-text">${scenario.text}</div>
                
                ${state.mode === 'community' ? `
                    <div class="explanation-box">
                        <h4>üåê Community Context</h4>
                        <p>Your friends will observe your choice. In a <strong>${state.institution}</strong> institution, 
                        ${state.institution === 'metabolic' 
                            ? 'repair loops will activate to support you and others who struggle.'
                            : 'there are no support systems‚Äîmoral debt will accumulate and spread.'
                        }</p>
                    </div>
                ` : ''}
                
                <h3>What will you do?</h3>
                <div class="choices-container">
                    ${scenario.choices.map((choice, i) => `
                        <button class="choice-button" onclick="makeChoice(${i})">
                            <span class="choice-label">${choice.label}</span>
                            <span class="choice-text">${choice.text}</span>
                        </button>
                    `).join('')}
                </div>
            `;
        }

        // ==========================================
        // CHOICE HANDLING
        // ==========================================
        function makeChoice(choiceIndex) {
            const scenario = scenarios[state.scenarioIndex];
            const choice = scenario.choices[choiceIndex];
            
            // Apply effects to player
            Object.keys(choice.effects).forEach(virtue => {
                state.player.virtues[virtue] = Math.max(0, Math.min(100, 
                    state.player.virtues[virtue] + choice.effects[virtue]
                ));
            });
            
            // PRF coherence damage (soul damage)
            state.player.prfCoherence = Math.max(0, state.player.prfCoherence - (choice.soulDamage / 100));
            state.player.moralDebt += choice.moralDebt;
            
            // Calculate new eudaimonia
            state.player.eudaimonia = calculateEudaimonia(state.player);
            
            if (state.mode === 'community') {
                // COMMUNITY MODE: Multi-agent dynamics
                processCommunityEffects(choice, scenario.testedVirtue);
            }
            
            // Record choice
            state.choices.push({ scenario: scenario.id, choice: choiceIndex });
            
            // Show results
            showChoiceResults(choice, scenario);
        }

        function calculateEudaimonia(agent) {
            // Eudaimonia based on virtue balance (golden mean) and PRF coherence
            const virtueDeviation = Object.values(agent.virtues)
                .map(v => Math.abs(v - 50))
                .reduce((a, b) => a + b, 0);
            
            const baseEudaimonia = Math.max(0, 100 - (virtueDeviation / 2));
            
            // Modified by PRF coherence and stress
            return Math.max(0, Math.min(100, 
                baseEudaimonia * agent.prfCoherence - agent.stress/5
            ));
        }

        // ==========================================
        // COMMUNITY DYNAMICS (ABM CORE) - NARRATIVE VERSION
        // ==========================================
        
        // Named characters (Sarah, Marcus, Elena are agents 1, 2, 3)
        const namedCharacters = {
            1: { name: "Sarah Chen", role: "graphic designer", startEud: 52 },
            2: { name: "Marcus Rodriguez", role: "legal assistant", startEud: 45 },
            3: { name: "Dr. Elena Patel", role: "research scientist", startEud: 58 }
        };
        
        function processCommunityEffects(playerChoice, testedVirtue) {
            const narratives = []; // Store what happened for display
            
            // Step 1: Social influence on named characters
            const friends = [1, 2, 3]; // Sarah, Marcus, Elena
            
            friends.forEach(friendId => {
                const friend = state.community[friendId];
                const char = namedCharacters[friendId];
                const influence = 0.15;
                
                const beforeCourage = friend.virtues.courage;
                const beforeEud = friend.eudaimonia;
                
                // Virtue contagion
                Object.keys(playerChoice.effects).forEach(virtue => {
                    const diff = state.player.virtues[virtue] - friend.virtues[virtue];
                    friend.virtues[virtue] += diff * influence;
                    friend.virtues[virtue] = Math.max(0, Math.min(100, friend.virtues[virtue]));
                });
                
                friend.eudaimonia = calculateEudaimonia(friend);
                
                // Generate narrative
                const virtueChange = Math.round(friend.virtues[testedVirtue] - (50 + (Math.random()-0.5)*20));
                const eudChange = friend.eudaimonia - beforeEud;
                
                if (playerChoice.effects[testedVirtue] > 0) {
                    narratives.push({
                        character: char.name,
                        text: `<strong>${char.name}</strong> noticed your courage and was inspired. She felt ${eudChange > 0 ? 'more confident' : 'conflicted'} about her own challenges. (${testedVirtue} ${virtueChange > 0 ? '+' : ''}${Math.round(virtueChange)})`,
                        type: 'positive'
                    });
                } else if (playerChoice.effects[testedVirtue] < 0) {
                    narratives.push({
                        character: char.name,
                        text: `<strong>${char.name}</strong> saw your choice. She wondered if staying silent might be safer after all. (${testedVirtue} ${virtueChange > 0 ? '+' : ''}${Math.round(virtueChange)})`,
                        type: 'negative'
                    });
                }
                
                // Update character display
                updateCharacterDisplay(friendId, friend);
            });
            
            // Step 2: BioBond Loop Activation with narrative
            let biobondActivated = false;
            state.community.forEach((agent, id) => {
                if (agent.eudaimonia < 50 && Math.random() < 0.6) {
                    agent.stress = Math.max(0, agent.stress - 15);
                    agent.prfCoherence = Math.min(1.0, agent.prfCoherence + 0.05);
                    
                    if (id === 2) { // Marcus
                        narratives.push({
                            character: "Marcus Rodriguez",
                            text: `<strong>Marcus</strong> took time to process his feelings. He practiced mindfulness and talked with his therapist. His stress decreased. <em>(BioBond Loop activated - personal self-care)</em>`,
                            type: 'repair'
                        });
                        biobondActivated = true;
                    }
                    
                    if (id === 0) state.repairLoops.biobond++;
                }
            });
            
            // Step 3: Civic Loop with narrative (only metabolic)
            if (state.institution === 'metabolic') {
                const struggling = state.community.filter((a, i) => a.eudaimonia < 40 && i > 3);
                struggling.forEach((agent, idx) => {
                    if (Math.random() < 0.4 && idx === 0) {
                        agent.moralDebt = Math.max(0, agent.moralDebt - 5);
                        agent.stress = Math.max(0, agent.stress - 10);
                        
                        narratives.push({
                            character: "Community",
                            text: `<strong>Jamie</strong> (another community member) was struggling. Your friend group organized a support circle. They listened to Jamie's story, validated their feelings, and helped them see a path forward. <em>(Civic Loop activated - peer support)</em>`,
                            type: 'repair'
                        });
                        
                        state.repairLoops.civic++;
                    }
                });
            } else {
                // Extractive - show blocked support
                narratives.push({
                    character: "System",
                    text: `<strong>Jamie</strong> reached out for help, but the institution has no support systems. HR told them "figure it out yourself." Their moral debt increased. <em>(Civic Loop BLOCKED by extractive institution)</em>`,
                    type: 'damage'
                });
            }
            
            // Step 4: Institutional Loop with narrative
            const avgEudaimonia = state.community.reduce((sum, a) => sum + a.eudaimonia, 0) / 20;
            
            if (state.institution === 'metabolic' && avgEudaimonia < 60) {
                state.community.forEach(agent => {
                    if (agent.eudaimonia < 50) {
                        agent.stress = Math.max(0, agent.stress - 20);
                        agent.moralDebt = Math.max(0, agent.moralDebt - 10);
                    }
                });
                
                narratives.push({
                    character: "Institution",
                    text: `<strong>Leadership noticed</strong> widespread stress around ethical dilemmas. They instituted a new policy: <em>anonymous whistleblower protection</em> and created a dedicated ethics hotline. Everyone's stress decreased. <em>(Institutional Loop activated - systemic change)</em>`,
                    type: 'repair'
                });
                
                state.repairLoops.institutional++;
                
            } else if (state.institution === 'extractive' && playerChoice.effects[testedVirtue] > 10) {
                // Extractive punishes virtue
                state.player.stress += 30;
                
                narratives.push({
                    character: "Institution",
                    text: `<strong>The institution retaliated.</strong> Your supervisor heard you reported the issue. You were put on a "performance improvement plan" - retaliation disguised as process. Your stress spiked. <em>(Extractive institution punishes virtue)</em>`,
                    type: 'damage'
                });
            }
            
            // Step 5: Update all agents
            state.community.forEach(agent => {
                agent.eudaimonia = calculateEudaimonia(agent);
            });
            
            // Step 6: Display narratives
            displayCommunityNarrative(narratives);
            
            // Step 7: Update visualizations
            updateCommunityStats();
            updateCharts();
            drawNetwork();
            updateRepairLoopDisplay();
        }
        
        function updateCharacterDisplay(friendId, agent) {
            const names = {
                1: { firstName: "Sarah", courageId: "sarahCourage", eudId: "sarahEudaimonia", statusId: "sarahStatus" },
                2: { firstName: "Marcus", justiceId: "marcusJustice", eudId: "marcusEudaimonia", statusId: "marcusStatus" },
                3: { firstName: "Elena", wisdomId: "elenaWisdom", eudId: "elenaEudaimonia", statusId: "elenaStatus" }
            };
            
            const char = names[friendId];
            if (!char) return;
            
            // Update virtue displays (with null checks)
            if (friendId === 1) {
                const el = document.getElementById(char.courageId);
                if (el) el.textContent = Math.round(agent.virtues.courage);
            }
            if (friendId === 2) {
                const el = document.getElementById(char.justiceId);
                if (el) el.textContent = Math.round(agent.virtues.justice);
            }
            if (friendId === 3) {
                const el = document.getElementById(char.wisdomId);
                if (el) el.textContent = Math.round(agent.virtues.wisdom);
            }
            
            // Update eudaimonia (with null check)
            const eudEl = document.getElementById(char.eudId);
            if (!eudEl) return;
            
            eudEl.textContent = Math.round(agent.eudaimonia);
            
            // Color based on level
            if (agent.eudaimonia >= 75) eudEl.style.color = '#4CAF50';
            else if (agent.eudaimonia >= 50) eudEl.style.color = '#667eea';
            else if (agent.eudaimonia >= 25) eudEl.style.color = '#FF9800';
            else eudEl.style.color = '#f44336';
            
            // Update status message (with null check)
            const statusEl = document.getElementById(char.statusId);
            if (!statusEl) return;
            
            if (agent.eudaimonia >= 70) {
                statusEl.innerHTML = `‚ú® Inspired by your example. Feeling more confident.`;
                statusEl.style.background = '#e8f5e9';
                statusEl.style.color = '#2e7d32';
            } else if (agent.eudaimonia >= 50) {
                statusEl.innerHTML = `üí≠ Reflecting on your choice. Processing what it means.`;
                statusEl.style.background = '#e3f2fd';
                statusEl.style.color = '#1976d2';
            } else if (agent.eudaimonia >= 30) {
                statusEl.innerHTML = `üòü Struggling with doubts. Your choice raised questions.`;
                statusEl.style.background = '#fff3e0';
                statusEl.style.color = '#e65100';
            } else {
                statusEl.innerHTML = `üò∞ In crisis. Needs support urgently.`;
                statusEl.style.background = '#ffebee';
                statusEl.style.color = '#c62828';
            }
        }
        
        function displayCommunityNarrative(narratives) {
            // Create a narrative box showing what happened
            const narrativeBox = document.createElement('div');
            narrativeBox.className = 'explanation-box';
            narrativeBox.style.cssText = 'background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-left-color: #667eea; margin-top: 30px; animation: fadeIn 0.5s;';
            
            narrativeBox.innerHTML = `
                <h4>üåê What Happened In Your Community</h4>
                <div style="margin-top: 20px;">
                    ${narratives.map(n => {
                        let color = '#666';
                        let icon = '‚Ä¢';
                        if (n.type === 'positive') { color = '#4CAF50'; icon = '‚úì'; }
                        else if (n.type === 'negative') { color = '#FF9800'; icon = '‚ö†'; }
                        else if (n.type === 'repair') { color = '#2196F3'; icon = 'üîß'; }
                        else if (n.type === 'damage') { color = '#f44336'; icon = '‚ö†'; }
                        
                        return `<p style="color: ${color}; margin: 15px 0; line-height: 1.8; font-size: 1.05em;">${icon} ${n.text}</p>`;
                    }).join('')}
                </div>
            `;
            
            // Insert after scenario container
            const scenarioContainer = document.getElementById('scenarioContainer');
            scenarioContainer.appendChild(narrativeBox);
        }

        function updateCommunityStats() {
            const avgEudaimonia = state.community.reduce((sum, a) => sum + a.eudaimonia, 0) / 20;
            
            document.getElementById('yourEudaimonia').textContent = Math.round(state.player.eudaimonia);
            document.getElementById('communityEudaimonia').textContent = Math.round(avgEudaimonia);
            document.getElementById('moralDebt').textContent = Math.round(state.player.moralDebt);
            
            // Update institution display
            document.getElementById('institutionType').textContent = state.institution === 'metabolic' ? 'üå±' : '‚ö°';
            document.getElementById('institutionName').textContent = state.institution === 'metabolic' ? 'Metabolic' : 'Extractive';
            
            // Update time series
            state.timeSeries.playerEudaimonia.push(state.player.eudaimonia);
            state.timeSeries.communityEudaimonia.push(avgEudaimonia);
            state.timeSeries.scenarios.push(state.scenarioIndex + 1);
        }

        function updateRepairLoopDisplay() {
            const maxActivations = state.scenarioIndex + 1;
            
            // BioBond
            const biobondPercent = (state.repairLoops.biobond / maxActivations) * 100;
            document.getElementById('biobondBar').style.width = biobondPercent + '%';
            document.getElementById('biobondCount').textContent = state.repairLoops.biobond;
            
            // Civic
            const civicPercent = (state.repairLoops.civic / maxActivations) * 100;
            document.getElementById('civicBar').style.width = civicPercent + '%';
            document.getElementById('civicCount').textContent = state.repairLoops.civic;
            
            // Institutional
            const instPercent = (state.repairLoops.institutional / maxActivations) * 100;
            document.getElementById('institutionalBar').style.width = instPercent + '%';
            document.getElementById('institutionalCount').textContent = state.repairLoops.institutional;
        }

        // ==========================================
        // RESULTS DISPLAY
        // ==========================================
        function showChoiceResults(choice, scenario) {
            const container = document.getElementById('scenarioContainer');
            
            const resultHTML = `
                <div class="explanation-box" style="margin-top: 30px;">
                    <h4>Results of Your Choice</h4>
                    <p><strong>${choice.label}</strong></p>
                    <p style="margin-top: 10px;">Your virtues changed:</p>
                    <ul style="margin-left: 25px;">
                        ${Object.entries(choice.effects).map(([virtue, change]) => 
                            change !== 0 ? `<li>${virtue}: ${change > 0 ? '+' : ''}${change}</li>` : ''
                        ).join('')}
                    </ul>
                    ${choice.soulDamage > 0 ? `
                        <p style="margin-top: 15px; color: #f44336;"><strong>‚ö†Ô∏è Soul Damage:</strong> 
                        PRF Coherence decreased by ${choice.soulDamage}%. This represents moral injury‚Äî
                        a mismatch between your actions and values.</p>
                    ` : ''}
                    ${choice.moralDebt > 0 ? `
                        <p style="margin-top: 10px; color: #f44336;"><strong>üìä Moral Debt:</strong> 
                        +${choice.moralDebt} accumulated. Unresolved ethical stress that compounds over time.</p>
                    ` : ''}
                    <p style="margin-top: 15px;"><strong>Current Eudaimonia:</strong> ${Math.round(state.player.eudaimonia)}</p>
                </div>
                
                ${state.mode === 'community' ? `
                    <div class="explanation-box" style="background: #e3f2fd; border-left-color: #2196F3;">
                        <h4>üåê Community Ripple Effects</h4>
                        <p>Your choice influenced ${state.socialNetwork.filter(e => e.source === 0 || e.target === 0).length} 
                        connected friends through social learning (Civic Loop potential).</p>
                        <p style="margin-top: 10px;">
                        ${state.institution === 'metabolic' 
                            ? 'The metabolic institution activated support systems. Repair loops helped struggling community members.'
                            : 'The extractive institution provided no support. Moral debt accumulated across the community.'
                        }
                        </p>
                        <p style="margin-top: 10px;"><strong>Community Average Eudaimonia:</strong> 
                        ${Math.round(state.community.reduce((sum, a) => sum + a.eudaimonia, 0) / 20)}</p>
                    </div>
                ` : ''}
                
                <div class="button-container">
                    <button class="btn-primary" onclick="nextScenario()">
                        Continue to Next Scenario ‚Üí
                    </button>
                </div>
            `;
            
            container.innerHTML += resultHTML;
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function nextScenario() {
            state.scenarioIndex++;
            showScenario(state.scenarioIndex);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showFinalResults() {
            showStep(3);
            
            const communityAvg = state.mode === 'community' 
                ? state.community.reduce((sum, a) => sum + a.eudaimonia, 0) / 20 
                : null;
            
            const finalHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2>Simulation Complete</h2>
                    <p style="font-size: 1.2em; margin: 30px 0;">
                        ${state.mode === 'individual' 
                            ? 'You have completed the individual virtue development journey.'
                            : `You experienced a <strong>${state.institution}</strong> institution over ${scenarios.length} scenarios.`
                        }
                    </p>
                    
                    <div class="community-stats">
                        <div class="stat-card">
                            <div class="stat-label">Final Eudaimonia</div>
                            <div class="stat-value">${Math.round(state.player.eudaimonia)}</div>
                            <div class="stat-change">${state.player.eudaimonia >= 75 ? 'Flourishing' : state.player.eudaimonia >= 50 ? 'Balanced' : state.player.eudaimonia >= 25 ? 'Struggling' : 'Crisis'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Moral Debt</div>
                            <div class="stat-value">${Math.round(state.player.moralDebt)}</div>
                            <div class="stat-change">${state.player.moralDebt === 0 ? 'Clean' : state.player.moralDebt < 20 ? 'Manageable' : 'Heavy'}</div>
                        </div>
                        ${state.mode === 'community' ? `
                            <div class="stat-card">
                                <div class="stat-label">Community Impact</div>
                                <div class="stat-value">${Math.round(communityAvg)}</div>
                                <div class="stat-change">${communityAvg >= 55 ? 'Thriving' : communityAvg >= 45 ? 'Holding' : 'Declining'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Repairs</div>
                                <div class="stat-value">${state.repairLoops.biobond + state.repairLoops.civic + state.repairLoops.institutional}</div>
                                <div class="stat-change">Soul Restoration Events</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${state.mode === 'community' ? `
                        <div class="explanation-box" style="margin: 40px auto; max-width: 900px; text-align: left;">
                            <h4>üî¨ What You Discovered</h4>
                            
                            <div style="background: white; padding: 25px; border-radius: 10px; margin: 20px 0;">
                                <h3 style="color: #667eea; margin-bottom: 15px;">Multi-Scale Moral Dynamics</h3>
                                <p style="line-height: 1.8; margin-bottom: 15px;">
                                    Your individual choices rippled through three levels of the system:
                                </p>
                                <ul style="margin-left: 25px; line-height: 2;">
                                    <li><strong>üßò BioBond (Individual):</strong> ${state.repairLoops.biobond} activations - Personal resilience through self-care and reflection</li>
                                    <li><strong>ü§ù Civic (Social):</strong> ${state.repairLoops.civic} activations - Peer support circles and collective sensemaking</li>
                                    <li><strong>üèõÔ∏è Institutional (Systemic):</strong> ${state.repairLoops.institutional} activations - Policy-level adaptation and protection</li>
                                </ul>
                            </div>
                            
                            <div style="background: ${state.institution === 'metabolic' ? '#e8f5e9' : '#ffebee'}; padding: 25px; border-radius: 10px; margin: 20px 0; border-left: 4px solid ${state.institution === 'metabolic' ? '#4CAF50' : '#f44336'};">
                                <h3 style="color: ${state.institution === 'metabolic' ? '#2e7d32' : '#c62828'}; margin-bottom: 15px;">
                                    ${state.institution === 'metabolic' ? 'üå± Metabolic Institution Impact' : '‚ö° Extractive Institution Impact'}
                                </h3>
                                <p style="line-height: 1.8;">
                                    ${state.institution === 'metabolic' 
                                        ? `The metabolic institution maintained <strong>high morphic fidelity</strong>‚Äîpolicy responses matched population needs. When people struggled, repair loops activated. PRF coherence (soul integrity) was preserved across the community. <strong>Pattern preservation</strong> worked: virtuous individuals ‚Üí supportive peers ‚Üí enabling policies.`
                                        : `The extractive institution showed <strong>low morphic fidelity</strong>‚Äîpolicy ignored or worsened stress. Civic and Institutional loops were blocked. Moral debt accumulated across the network. Soul damage cascaded. Even virtuous choices led to punishment and retaliation. <strong>Pattern breaking</strong>: good individuals ‚Üí unsupported peers ‚Üí punitive policies.`
                                    }
                                </p>
                            </div>
                            
                            <div style="background: #f3e5f5; padding: 25px; border-radius: 10px; margin: 20px 0;">
                                <h3 style="color: #6a1b9a; margin-bottom: 15px;">Your Friends' Outcomes</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                    <div>
                                        <strong>üé® Sarah Chen:</strong><br>
                                        Final Eudaimonia: <strong style="color: ${state.community[1].eudaimonia >= 60 ? '#4CAF50' : state.community[1].eudaimonia >= 45 ? '#FF9800' : '#f44336'};">${Math.round(state.community[1].eudaimonia)}</strong><br>
                                        ${state.community[1].eudaimonia >= 60 ? '‚ú® Inspired and thriving' : state.community[1].eudaimonia >= 45 ? 'üí≠ Still processing' : 'üò∞ Struggling significantly'}
                                    </div>
                                    <div>
                                        <strong>‚öñÔ∏è Marcus Rodriguez:</strong><br>
                                        Final Eudaimonia: <strong style="color: ${state.community[2].eudaimonia >= 60 ? '#4CAF50' : state.community[2].eudaimonia >= 45 ? '#FF9800' : '#f44336'};">${Math.round(state.community[2].eudaimonia)}</strong><br>
                                        ${state.community[2].eudaimonia >= 60 ? '‚ú® Found moral clarity' : state.community[2].eudaimonia >= 45 ? 'üí≠ Cautiously hopeful' : 'üò∞ In moral crisis'}
                                    </div>
                                    <div>
                                        <strong>üî¨ Dr. Elena Patel:</strong><br>
                                        Final Eudaimonia: <strong style="color: ${state.community[3].eudaimonia >= 60 ? '#4CAF50' : state.community[3].eudaimonia >= 45 ? '#FF9800' : '#f44336'};">${Math.round(state.community[3].eudaimonia)}</strong><br>
                                        ${state.community[3].eudaimonia >= 60 ? '‚ú® Strengthened wisdom' : state.community[3].eudaimonia >= 45 ? 'üí≠ Reassessing approach' : 'üò∞ Deeply troubled'}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #2196F3;">
                                <h4 style="color: #1565c0; margin-bottom: 10px;">üí° Key Insight</h4>
                                <p style="font-size: 1.1em; line-height: 1.8;">
                                    <strong>Same virtuous choices ‚Üí Opposite outcomes based on institutional design.</strong><br>
                                    This demonstrates that ethics isn't just about individual character‚Äîit's about whether 
                                    institutions enable or destroy the capacity for virtue. Aristotle knew this: 
                                    "The polis exists to make eudaimonia possible."
                                </p>
                            </div>
                        </div>
                        
                        <div class="explanation-box" style="margin: 40px auto; max-width: 900px; text-align: left; background: #fff3e0; border-left-color: #f57c00;">
                            <h4>üéì What To Try Next</h4>
                            <p style="line-height: 1.8; margin-bottom: 15px;">
                                Run the simulation again with the <strong>opposite institution type</strong>. 
                                Make the same choices and watch completely different outcomes emerge. 
                                This shows the power (and danger) of institutional design.
                            </p>
                            <p style="line-height: 1.8;">
                                Or try <strong>Individual Mode</strong> to focus purely on personal virtue development 
                                without social dynamics‚Äîthe classical Aristotelian approach.
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="button-container" style="margin-top: 40px;">
                        <button class="btn-primary" onclick="location.reload()">
                            üîÑ Start New Simulation
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('finalResults').innerHTML = finalHTML;
        }

        // ==========================================
        // NAVIGATION
        // ==========================================
        function showStep(stepNum) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            if (stepNum === 1) {
                document.getElementById('step1').classList.add('active');
                // Show/hide institutional context based on mode
                if (state.mode === 'community') {
                    document.getElementById('institutionalContext').style.display = 'block';
                } else {
                    document.getElementById('institutionalContext').style.display = 'none';
                }
            } else if (stepNum === 2) {
                document.getElementById('scenarioStep').classList.add('active');
            } else if (stepNum === 3) {
                document.getElementById('step12').classList.add('active');
            }
            
            state.currentStep = stepNum;
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==========================================
        // INTERACTIVE DEMO/TUTORIAL
        // ==========================================
        let tutorialMode = false;
        let tutorialStep = 0;

        function startInteractiveTutorial() {
            tutorialMode = true;
            tutorialStep = 0;
            
            // Hide mode selector
            document.querySelector('.mode-selector').style.display = 'none';
            
            // Initialize with demo scenario
            state.mode = 'community';
            state.institution = 'metabolic';
            initializeCommunity();
            
            // Show first tutorial step
            showTutorialStep(0);
        }

        function showTutorialStep(step) {
            const overlay = document.createElement('div');
            overlay.id = 'tutorialOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            const tutorialSteps = [
                {
                    title: "üéì Interactive Demo: See How It Works",
                    content: `
                        <p style="font-size: 1.1em; line-height: 1.8; margin-bottom: 20px;">
                            Let me show you <strong>exactly</strong> what happens when you make a choice 
                            in Community Mode. We'll watch the effects ripple through the network in real-time.
                        </p>
                        <p style="font-size: 1.1em; line-height: 1.8;">
                            I've created a small community of 20 people. You're connected to 3 friends: 
                            <strong style="color: #667eea;">Sarah</strong>, 
                            <strong style="color: #667eea;">Marcus</strong>, and 
                            <strong style="color: #667eea;">Elena</strong>.
                        </p>
                        <p style="font-size: 1.1em; line-height: 1.8; margin-top: 20px;">
                            We're in a <strong style="color: #4CAF50;">Metabolic Institution</strong> 
                            (supportive school/workplace).
                        </p>
                    `,
                    buttonText: "Show Me What Happens ‚Üí"
                },
                {
                    title: "üìñ The Scenario",
                    content: `
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 20px 0;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">The Dangerous Truth</h3>
                            <p style="font-size: 1.1em; line-height: 1.8;">
                                You witness your supervisor falsifying safety reports. Speaking up could 
                                cost you your job. Staying silent might endanger coworkers.
                            </p>
                        </div>
                        <p style="font-size: 1.1em; line-height: 1.8; margin-top: 20px;">
                            This tests <strong>COURAGE</strong> - the virtue of facing fear appropriately.
                        </p>
                        <p style="font-size: 1.1em; line-height: 1.8; margin-top: 20px;">
                            Let's say you choose: <strong style="color: #4CAF50;">"Report through proper channels"</strong>
                            (the virtuous choice - golden mean between cowardice and recklessness).
                        </p>
                    `,
                    buttonText: "Watch The Ripple Effects ‚Üí"
                },
                {
                    title: "‚ö° Step 1: Your Soul Changes",
                    content: `
                        <p style="font-size: 1.1em; line-height: 1.8; margin-bottom: 20px;">
                            <strong>Direct effects on YOU:</strong>
                        </p>
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin: 15px 0;">
                            <p style="font-size: 1.05em; margin: 10px 0;">
                                ‚úÖ <strong>Courage:</strong> +15 (you practiced bravery)
                            </p>
                            <p style="font-size: 1.05em; margin: 10px 0;">
                                ‚úÖ <strong>Justice:</strong> +15 (you did the right thing)
                            </p>
                            <p style="font-size: 1.05em; margin: 10px 0;">
                                ‚úÖ <strong>Wisdom:</strong> +10 (you used good judgment)
                            </p>
                            <p style="font-size: 1.05em; margin: 10px 0;">
                                ‚úÖ <strong>PRF Coherence:</strong> No damage (actions match values)
                            </p>
                            <p style="font-size: 1.05em; margin: 10px 0;">
                                ‚úÖ <strong>Moral Debt:</strong> None accumulated
                            </p>
                        </div>
                        <p style="font-size: 1.1em; line-height: 1.8; margin-top: 20px;">
                            Your <strong>Eudaimonia</strong> (flourishing) increases because your virtues 
                            moved closer to the golden mean and you maintained soul coherence.
                        </p>
                    `,
                    buttonText: "See Social Effects ‚Üí"
                },
                {
                    title: "ü§ù Step 2: Your Friends Notice",
                    content: `
                        <p style="font-size: 1.1em; line-height: 1.8; margin-bottom: 20px;">
                            <strong>Your 3 friends observe your choice:</strong>
                        </p>
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 15px 0;">
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                <strong style="color: #667eea;">Sarah</strong> sees you act courageously. 
                                Her courage increases by <strong>+2</strong> (social learning).
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                <strong style="color: #667eea;">Marcus</strong> notices. 
                                His courage increases by <strong>+3</strong>.
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                <strong style="color: #667eea;">Elena</strong> is inspired. 
                                Her courage increases by <strong>+2</strong>.
                            </p>
                        </div>
                        <p style="font-size: 1.1em; line-height: 1.8; margin-top: 20px;">
                            This is <strong style="color: #667eea;">social contagion</strong> - 
                            virtue spreads through your network. Your courage made courage more likely in others.
                        </p>
                        <p style="font-size: 1em; margin-top: 15px; color: #666; font-style: italic;">
                            (In the network graph, you'd see your friends' circles shift toward green)
                        </p>
                    `,
                    buttonText: "See Repair Loops Activate ‚Üí"
                },
                {
                    title: "üßò Step 3: Repair Loops Activate",
                    content: `
                        <p style="font-size: 1.1em; line-height: 1.8; margin-bottom: 20px;">
                            But what about people who ARE struggling? The system responds:
                        </p>
                        <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin: 15px 0;">
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                <strong>üßò BioBond Loop:</strong> 
                                Marcus was stressed before (eudaimonia 48). He takes time for self-care. 
                                Stress reduced by 15 points. He recovers.
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                <strong>ü§ù Civic Loop:</strong> 
                                Another community member, Jamie (eudaimonia 35), gets peer support. 
                                Your friend group helps them process their moral struggle. 
                                Moral debt reduced by 5.
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                <strong>üèõÔ∏è Institutional Loop:</strong> 
                                The institution notices several people struggling with similar whistleblowing dilemmas. 
                                HR creates a new anonymous reporting system. Protection policy implemented. 
                                Community-wide stress reduced by 20.
                            </p>
                        </div>
                        <p style="font-size: 1.1em; line-height: 1.8; margin-top: 20px;">
                            These loops ONLY work because we're in a <strong style="color: #4CAF50;">Metabolic Institution</strong>. 
                            In an extractive one, these supports would be blocked.
                        </p>
                    `,
                    buttonText: "See Final Results ‚Üí"
                },
                {
                    title: "üìä Step 4: Community Transformation",
                    content: `
                        <p style="font-size: 1.1em; line-height: 1.8; margin-bottom: 20px;">
                            <strong>Final Effects Across The Entire Community:</strong>
                        </p>
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin: 15px 0;">
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                ‚úÖ <strong>Your eudaimonia:</strong> 50 ‚Üí 67 (+17 points)
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                ‚úÖ <strong>Community average:</strong> 50 ‚Üí 54 (+4 points)
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                ‚úÖ <strong>Your 3 friends:</strong> All improved (courage spread)
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                ‚úÖ <strong>Struggling members:</strong> 3 people recovered through repair loops
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                ‚úÖ <strong>Institutional change:</strong> New policy protects future whistleblowers
                            </p>
                        </div>
                        <p style="font-size: 1.1em; line-height: 1.8; margin-top: 20px;">
                            <strong>This is emergence:</strong> Your one choice created ripples at three levels 
                            (individual ‚Üí social ‚Üí institutional), transforming the entire community's capacity for virtue.
                        </p>
                    `,
                    buttonText: "Compare: What If Extractive? ‚Üí"
                },
                {
                    title: "‚ö° The Extractive Alternative",
                    content: `
                        <p style="font-size: 1.1em; line-height: 1.8; margin-bottom: 20px;">
                            <strong>Same choice, but in an EXTRACTIVE institution:</strong>
                        </p>
                        <div style="background: #ffebee; padding: 20px; border-radius: 10px; margin: 15px 0;">
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                ‚úÖ <strong>You still improve:</strong> Your personal virtues increase
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                ‚úÖ <strong>Friends still notice:</strong> Social contagion still happens
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                ‚ùå <strong>BUT: No Civic Loop</strong> - Jamie gets no peer support (blocked)
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                ‚ùå <strong>No Institutional Loop</strong> - HR ignores the problem
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                ‚ùå <strong>Worse: Institution punishes you</strong> - You're fired for reporting
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                ‚ùå <strong>Your stress spikes:</strong> +30 points (retaliation trauma)
                            </p>
                            <p style="font-size: 1.05em; margin: 15px 0;">
                                ‚ùå <strong>Jamie collapses:</strong> Moral debt +20, eudaimonia 35 ‚Üí 18
                            </p>
                        </div>
                        <p style="font-size: 1.1em; line-height: 1.8; margin-top: 20px; color: #f44336;">
                            <strong>Result:</strong> You tried to be virtuous, but the extractive institution 
                            damaged your soul anyway. This is <em>moral injury</em> - doing the right thing 
                            gets punished instead of supported.
                        </p>
                    `,
                    buttonText: "I Understand - Start Simulation ‚Üí"
                }
            ];
            
            const currentStep = tutorialSteps[step];
            
            overlay.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <h2 style="color: #667eea; margin-bottom: 30px; font-size: 2em;">
                        ${currentStep.title}
                    </h2>
                    <div style="line-height: 1.8;">
                        ${currentStep.content}
                    </div>
                    <div style="display: flex; gap: 20px; margin-top: 40px; justify-content: center;">
                        ${step > 0 ? `
                            <button onclick="previousTutorialStep()" style="padding: 15px 30px; font-size: 18px; background: #e0e0e0; border: none; border-radius: 10px; cursor: pointer;">
                                ‚Üê Back
                            </button>
                        ` : ''}
                        <button onclick="nextTutorialStep()" style="padding: 15px 30px; font-size: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                            ${currentStep.buttonText}
                        </button>
                    </div>
                    ${step === 0 ? `
                        <p style="text-align: center; margin-top: 20px; color: #666;">
                            <a href="#" onclick="skipTutorial()" style="color: #667eea; text-decoration: none;">
                                Skip tutorial and explore on my own ‚Üí
                            </a>
                        </p>
                    ` : ''}
                </div>
            `;
            
            document.body.appendChild(overlay);
        }

        function nextTutorialStep() {
            document.getElementById('tutorialOverlay').remove();
            tutorialStep++;
            
            if (tutorialStep >= 7) {
                // Tutorial complete
                tutorialMode = false;
                document.getElementById('communityDashboard').style.display = 'block';
                initializeCharts();
                showScenario(0);
                showStep(2);
            } else {
                showTutorialStep(tutorialStep);
            }
        }

        function previousTutorialStep() {
            document.getElementById('tutorialOverlay').remove();
            tutorialStep--;
            showTutorialStep(tutorialStep);
        }

        function skipTutorial() {
            document.getElementById('tutorialOverlay').remove();
            tutorialMode = false;
            // Show step 1 (character creation/institutional selection)
            showStep(1);
        }

        // ==========================================
        // INFO MODAL
        // ==========================================
        function showInfo() {
            alert('Virtue Ethics: Individual & Community\n\n' +
                  'Individual Mode: Classical Aristotelian virtue development\n\n' +
                  'Community Mode: Agent-based model using Adaptive Moral Social Dynamics framework\n\n' +
                  '‚Ä¢ BROA+ agents with PRF coherence tracking\n' +
                  '‚Ä¢ Three repair loops (BioBond, Civic, Institutional)\n' +
                  '‚Ä¢ Social contagion of virtue/vice\n' +
                  '‚Ä¢ Metabolic vs Extractive institutional contexts\n' +
                  '‚Ä¢ Moral debt accumulation and amortization\n' +
                  '‚Ä¢ Morphic fidelity (pattern preservation across scales)');
        }

        // ==========================================
        // INITIALIZATION ON PAGE LOAD
        // ==========================================
        window.addEventListener('load', () => {
            console.log('Virtue Ethics Community ABM loaded successfully');
            console.log('Current mode:', state.mode);
            console.log('Chart.js available:', typeof Chart !== 'undefined');
            
            // Make sure mode selector is visible
            document.querySelector('.mode-selector').style.display = 'block';
        });
    </script>
</body>
</html>
